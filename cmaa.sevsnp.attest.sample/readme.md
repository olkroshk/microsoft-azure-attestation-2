# SEV-SNP Attestation Sample with Azure Attestation

This is a minimal .NET console application that interacts with the Microsoft Azure Attestation (MAA) service for SEV-SNP virtual machine attestation. It sends an attestation request, retrieves a signed token, and allows further validation steps.

## Remote Attestation Flow with SEV-SNP

### 1. Collect Attestation Evidence
The confidential environment undergoing attestation (e.g., a confidential ACI container, SGX enclave, or Azure Confidential VM) generates attestation evidence that reflects its identity, state, and configuration.

### 2. Submit Evidence for Attestation
The attestation evidence is sent to the **Microsoft Azure Attestation (MAA)** service, which verifies the evidence against platform-specific security guarantees. If the attestation succeeds, MAA issues a signed JWT token.

### 3. Validate the Attestation Token
The signed JWT token is provided to a **relying party** that requires trust verification before interacting with the confidential environment (e.g., **Azure Key Vault for secure key release**). The relying party validates the JWT token by:
- Verifying the token signature.
- Optionally inspecting the attestation evidence to confirm MAA's TEE hosting environment.

### 4. Authorization Decision
Based on the validated attestation claims, the relying party makes an authorization decision on whether to trust and engage with the attested environment.

---

## How to Establish Trust with Azure Attestation

### 1. Verify if the Attestation Token is Generated by Azure Attestation
An attestation token generated by **Azure Attestation** is signed using a **self-signed certificate**. The signing certificate's URL is exposed via an **OpenID metadata endpoint**. A relying party can retrieve the signing certificate and perform **signature verification** of the attestation token.

ðŸ‘‰ **See code samples for more details.**

### 2. Verify if Azure Attestation is Running Inside an SGX Enclave or SEV-SNP Container
The **token signing certificates** contain information about the **Trusted Execution Environment (TEE)** in which Azure Attestation runs. This **TEE collateral** could be an **SGX quote** or a **SEV-SNP report**.

A relying party can validate if Azure Attestation is running inside a valid **TEE** by:
- Extracting the **SGX quote** or **SEV-SNP report** from the signing certificate.
- Performing local validation.

ðŸ‘‰ **See code samples for more details.**

### 3. Validate the Binding of Azure Attestation TEE Collateral with the Key That Signed the Attestation Token
A relying party can verify if the **hash of the public key** that signed the attestation token matches the **report data field** in the Azure Attestation **TEE collateral**.

ðŸ‘‰ **See code samples for more details.**

### 4. Validate if Azure Attestation Code Measurements Match the Azure Published Values
The **TEE collateral** embedded in an **attestation token signing certificate** includes **TEE code measurements** of Azure Attestation. A relying party can verify that the **quote or report** belongs to Azure Attestation by comparing it against specific values provided by the Azure Attestation team.

- **For SGX**: Validate **MRSIGNER**.
- **For SEV-SNP**: Validate **HOST_DATA** and **TBD**.

If you are interested in performing this validation, submit a request via the **[Azure Support page](https://azure.microsoft.com/en-us/support/)**. The **Azure Attestation team** will notify you before planned **rotations** of these values.

### **Rotation of Trust Values**
Values identifying **valid Azure Attestation instances** may change when:
- **Code signing certificates are rotated**
- **Security updates require new policy versions**

#### **Planned Rotations**
The **Azure Attestation team follows this rollout schedule** for every planned rotation:

1. **Notification** â€“ Consumers are notified of new values with a **two-month grace period** to update their code.
2. **Transition Period** â€“ After the two-month grace period, Azure Attestation **starts using the new values**.
3. **Deprecation** â€“ Three months after the notification date, **Azure Attestation stops using the old values**.

#### **Unplanned Rotations**
For **unplanned rotations**, including those required by **security updates**, the Azure Attestation team will provide updated values with a **one-month grace period** for implementation.

---

## Prerequisites

- **.NET SDK 8.0 or later** installed ([Download .NET](https://dotnet.microsoft.com/download))
- Internet access to reach the attestation endpoint
- An attestation instance URL (e.g., `https://instance.attest.azure.net`)

## Installation

### Project Location
This project is located in the `/cmaa.sevsnp.attest.sample` folder in the root of the repository.

### Ensure Dependencies

Ensure that `Newtonsoft.Json` is installed in your project. If it's missing, add it with:

```sh
dotnet add package Newtonsoft.Json
```

### Use the Provided Implementation

The provided code is already in `Program.cs`. Ensure that it contains the correct implementation.

## Setting Up in VS Code

### 1. Install VS Code and Required Extensions
- Download and install **[VS Code](https://code.visualstudio.com/)**
- Install the following extensions:
  - **C# Dev Kit**
  - **.NET Install Tool**
  - **C# (OmniSharp)**

### 2. Open the Project in VS Code
- Open **VS Code**
- Click **File > Open Folder** and select the `/cmaa.sevsnp.attest.sample` folder

### 3. Run the Application
- Open **Terminal (`Ctrl + ~`)**
- Run:
  ```sh
  dotnet run
  ```

### 4. Debugging in VS Code
- Open **Program.cs**
- Add a **breakpoint** by clicking on the left margin
- Press **F5** to start debugging

## Usage

### Running the Application

Navigate to the project directory:
```sh
cd /cmaa.sevsnp.attest.sample
```
Then run:
```sh
dotnet run
```

### Expected Output

If successful, the application will:

- Send an attestation request.
- Retrieve an attestation token.
- Print the token to the console.

```sh
Attestation Token: eyJhbGciOiJSUzI1NiIs...
Validation steps to be implemented...
```

### Error Handling

If thereâ€™s an issue with the request, youâ€™ll see:

```sh
Error: [Detailed error message]
```

## Request and API Definitions

- A sample request for attestation is available in the **Swagger definition for MAA API version 2022-08-01**:
  - [Attestation Request Example](https://github.com/Azure/azure-rest-api-specs/blob/main/specification/attestation/data-plane/Microsoft.Attestation/stable/2022-08-01/examples/AttestSevSnpVm.json)
- The full **API schema definitions** can be found here:
  - [API Swagger Definition](https://github.com/Azure/azure-rest-api-specs/blob/main/specification/attestation/data-plane/Microsoft.Attestation/stable/2022-08-01/attestation.json)
