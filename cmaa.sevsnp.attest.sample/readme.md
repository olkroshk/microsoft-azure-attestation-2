# SEV-SNP Attestation Sample with Azure Attestation

This is a minimal .NET console application that interacts with the Microsoft Azure Attestation (MAA) service for SEV-SNP attestation type.

## Remote Attestation Flow with SEV-SNP

### 1. Collect Attestation Evidence

The confidential environment undergoing attestation (e.g., a confidential ACI container, SGX enclave, or Azure Confidential VM) generates attestation evidence that reflects its identity, state, and configuration.

### 2. Submit Evidence for Attestation

The attestation evidence is sent to the **Microsoft Azure Attestation (MAA)** service, which verifies the evidence against platform-specific security guarantees. If the attestation succeeds, MAA issues a signed JWT token.

### 3. Validate the Attestation Token

The signed JWT token is provided to a **relying party** that requires trust verification before interacting with the confidential environment (e.g., **Azure Key Vault for secure key release**). The relying party validates the JWT token by:

- Verifying the token signature.
- Optionally inspecting the attestation evidence to confirm MAA's TEE hosting environment.

### 4. Authorization Decision

Based on the validated attestation claims, the relying party makes an authorization decision on whether to trust and engage with the attested environment.

## **How to Establish Trust with Azure Attestation**  

### **1. Verify if the attestation token is generated by Azure Attestation**  
An attestation token generated by **Azure Attestation** is signed using a **self-signed certificate**. The signing certificate’s URL is included in the attestation token as a **signing certificate endpoint**. The relying party can retrieve this certificate and **perform signature verification** of the attestation token. See [code sample](Program.cs#L196).

### **2. Verify if Azure Attestation is running inside an SEV-SNP container**  
The attestation token’s **signing certificate** contains information about the **Trusted Execution Environment (TEE)** in which Azure Attestation is running. This collateral includes a **SEV-SNP report**. The relying party can verify that **Azure Attestation is running inside a valid SEV-SNP environment** by extracting this information from the signing certificate and validating it locally. See [code sample](Program.cs#L286).

### **3. Validate binding of Azure Attestation TEE collateral with the key that signed the attestation token**  
The attestation token includes a **public key** that was used to sign it. The TEE collateral contains a **SHA-256 hash of this key** in the `x-ms-sevsnpvm-reportdata` claim. The relying party can verify that the **hash of the public key that signed the attestation token matches the report data field** in the Azure Attestation TEE collateral. See [code sample](Program.cs#L355). 

### **4. Validate if Azure Attestation code measurements match the Azure published values**  
The **TEE collateral** embedded in the **attestation token’s signing certificate** includes **TEE code measurements** of **Azure Attestation**. The relying party can verify that the attestation token corresponds to an approved Azure Attestation deployment by comparing the values in the TEE collateral with the **official values provided by Azure Attestation**.  

For **SEV-SNP**, the relying party should validate **`HOST_DATA`** and other relevant security properties. See [code sample](Program.cs#L395).

## How to Run

### Prerequisites

- **.NET SDK 8.0 or later** installed ([Download .NET](https://dotnet.microsoft.com/download))
- Internet access to reach the attestation endpoint
- An attestation instance URL (e.g., `https://instance.attest.azure.net`)
- **Clone the Repository**:

  ```sh
  git clone --recursive https://github.com/Azure-Samples/microsoft-azure-attestation.git
  cd microsoft-azure-attestation/cmaa.sevsnp.attest.sample
  ```

### Installation and Setup

#### Windows Setup

1. **Install .NET SDK** if not already installed.
2. Open **Command Prompt** or **PowerShell**.
3. Navigate to the project directory:

   ```sh
   cd microsoft-azure-attestation/cmaa.sevsnp.attest.sample
   ```

4. Restore dependencies:

   ```sh
   dotnet restore
   ```

5. Build the project:

   ```sh
   dotnet build
   ```

6. Run the application with an optional SEV-SNP report parameter:

   ```sh
   dotnet run
   ```

#### Linux Setup

1. **Install .NET SDK**:

   ```sh
   sudo apt update
   sudo apt install -y dotnet-sdk-8.0
   ```

2. Open a terminal and navigate to the project directory:

   ```sh
   cd microsoft-azure-attestation/cmaa.sevsnp.attest.sample
   ```

3. Restore dependencies:

   ```sh
   dotnet restore
   ```

4. Build the project:

   ```sh
   dotnet build
   ```

5. Run the application:

   ```sh
   dotnet run
   ```

### Debugging and Development: Using VS Code

1. Install **[VS Code](https://code.visualstudio.com/)**.
2. Install extensions:
   - **C# Dev Kit**
   - **.NET Install Tool**
   - **C# (OmniSharp)**
3. Open **VS Code** and load the project.
4. Add breakpoints in `Program.cs`.
5. Press **F5** to start debugging.

## References

- [Microsoft Azure Attestation API](https://github.com/Azure/azure-rest-api-specs/tree/main/specification/attestation/data-plane/Microsoft.Attestation/stable/2022-08-01)
- [Attestation Request Example](https://github.com/Azure/azure-rest-api-specs/blob/main/specification/attestation/data-plane/Microsoft.Attestation/stable/2022-08-01/examples/AttestSevSnpVm.json)
