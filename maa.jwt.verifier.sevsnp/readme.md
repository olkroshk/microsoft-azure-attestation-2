# SEV-SNP Attestation Sample with Azure Attestation

This is a minimal .NET console application that interacts with the Microsoft Azure Attestation (MAA) service for SEV-SNP attestation type.

## Remote Attestation Flow with SEV-SNP

1. Collect Attestation Evidence. The confidential environment undergoing attestation (e.g., a confidential ACI container, SGX enclave, or Azure Confidential VM) generates attestation evidence that reflects its identity, state, and configuration.

2. Submit Evidence for Attestation. The attestation evidence is sent to the **Microsoft Azure Attestation (MAA)** service, which verifies the evidence against platform-specific security guarantees. If the attestation succeeds, MAA issues a signed JWT token.

3. Validate the Attestation Token. The signed JWT token is provided to a **relying party** that requires trust verification before interacting with the confidential environment (e.g., **Azure Key Vault for secure key release**). The relying party validates the JWT token by verifying signatures and inspecting the attestation evidence to confirm MAA's TEE hosting environment.

4. Authorization Decision. Based on the validated attestation claims, the relying party makes an authorization decision on whether to trust and engage with the attested environment.

## How to Verify MAA JWT for SEV-SNP

### Verify that the attestation token is generated by Azure Attestation

Attestation tokens from Azure Attestation are JWTs signed using a certificate chain rooted in a trusted MAA certificate. The token header includes a `jku` (JWK Set URL) parameter, which points to the endpoint hosting the signing certificates. The verifier must retrieve the signing keys from this URL, select the key matching the `kid` in the JWT header, and validate the token's signature and expiration.

The signing certificates are also available via the [OpenID metadata endpoint](https://learn.microsoft.com/en-us/rest/api/attestation/metadata-configuration/get?view=rest-attestation-2022-08-01&tabs=HTTP#get-openid-metadata), for example:  
`https://<your-instance>.attest.azure.net/.well-known/openid-configuration`

See [code](Program.cs#L161) for an implementation example.

### Verify that the certificate is rooted in the trusted MAA root key

Verify that the certificate used to sign the JWT chains back to the trusted MAA root key. Use the trusted RSA public key to validate the certificateâ€™s signature. Reach out to the Azure Attestation (MAA) team to obtain the correct MAA root key.

See [code](Program.cs#L120) for an implementation example.

### Verify that TEE Kind is SEV-SNP

Verify that the signing certificate contains data indicating that it was issued by a SEV-SNP platform. This is done by checking the TEE Kind X.509 extension in the certificate and confirming that its value corresponds to `sev-snp`. If the extension is missing or the value does not match, the platform is not considered valid.

See [code](Program.cs#L203).

### Verify SEVSNP report roots to AMD

The attestation certificate includes the SEV-SNP report and a VCEK certificate chain. The verifier needs to:

- Extract the VCEK certificate chain (in PEM format)
- Parse and validate the certificate chain
- Verify that the chain roots to one of AMD's trusted root keys
- Extract the public ECDSA P-384 key from the leaf certificate
- Verify the signature on the SEV-SNP report using this key

See [code](Program.cs#L245).

### Verify SEVSNP.launchmeasurement equals COSE.launchmeasurement

The COSE UVM endorsement includes a `launchMeasurement` claim. This must match the `measurement` value in the SEV-SNP report. The values are compared byte-for-byte.

See [code](Program.cs#L354).

### Verify PRSS endorsement for UVM image roots to Key-PRSS-ACI

The COSE endorsement includes a certificate chain in its protected header. The verifier must:

- Parse the COSE Sign1 structure
- Validate the embedded signature
- Validate the certificate chain
- Confirm that the chain roots to a known trusted PRSS key

See [code](Program.cs#L507).

### Verify SEVSNP.hostdata matches hash of Rego policy containing Key-PRSS-MAA

The `host_data` field in the SEV-SNP report must be set to the SHA-256 hash of the current policy. This is computed outside the token and compared to the report.

See [code](Program.cs#L322).

### Verify SEVSNP.reportdata matches hash of MAA runtime claims

The lower 32 bytes of the `report_data` field in the SEV-SNP report must equal the SHA-256 hash of the PEM-formatted public key used to sign the JWT. The upper 32 bytes must be all zero. This step proves the attestation is cryptographically bound to the signer.

See [code](Program.cs#L398).

## How to Run

### Prerequisites

- [.NET SDK 8.0+](https://dotnet.microsoft.com/download)
- Internet access
- Attestation instance URL (e.g., `https://instance.attest.azure.net`)

### Clone and Run

```sh
git clone --recursive https://github.com/Azure-Samples/microsoft-azure-attestation.git
cd microsoft-azure-attestation/cmaa.sevsnp.attest.sample
dotnet restore
dotnet build
dotnet run
```

### Optional: Run in Visual Studio Code

Open the folder in [VS Code](https://code.visualstudio.com/) and press `F5` to start debugging.

## References

- [Microsoft Azure Attestation API](https://github.com/Azure/azure-rest-api-specs/tree/main/specification/attestation/data-plane/Microsoft.Attestation/stable/2022-08-01)
- [Attestation Request Example](https://github.com/Azure/azure-rest-api-specs/blob/main/specification/attestation/data-plane/Microsoft.Attestation/stable/2022-08-01/examples/AttestSevSnpVm.json)
