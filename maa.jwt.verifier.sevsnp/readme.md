# SEV-SNP Attestation Sample with Azure Attestation

This is a minimal .NET console application that interacts with the Microsoft Azure Attestation (MAA) service for SEV-SNP attestation type.

## Remote Attestation Flow with SEV-SNP

1. Collect Attestation Evidence. The confidential environment undergoing attestation (e.g., a confidential ACI container, SGX enclave, or Azure Confidential VM) generates attestation evidence that reflects its identity, state, and configuration.

2. Submit Evidence for Attestation. The attestation evidence is sent to the **Microsoft Azure Attestation (MAA)** service, which verifies the evidence against platform-specific security guarantees. If the attestation succeeds, MAA issues a signed JWT token.

3. Validate the Attestation Token. The signed JWT token is provided to a **relying party** that requires trust verification before interacting with the confidential environment (e.g., **Azure Key Vault for secure key release**). The relying party validates the JWT token by verifying signatures and inspecting the attestation evidence to confirm MAA's TEE hosting environment.

4. Authorization Decision. Based on the validated attestation claims, the relying party makes an authorization decision on whether to trust and engage with the attested environment.

## How to Verify MAA JWT for SEV-SNP

### Verify that the attestation token is generated by Azure Attestation

Attestation tokens from Azure Attestation are JWTs signed using a certificate chain rooted in a trusted MAA certificate. The token header includes a jku (JWK Set URL) parameter, which points to the endpoint hosting the signing certificates. The relying party must retrieve the signing keys from this URL, extract the appropriate public key (matching the kid), and verify the token’s signature. Ensure that the key chains up to the trusted MAA root certificate.

The signing certificates are also exposed via the [OpenID metadata endpoint](https://learn.microsoft.com/en-us/rest/api/attestation/metadata-configuration/get?view=rest-attestation-2022-08-01&tabs=HTTP#get-openid-metadata), for exmaple `https://instance.attest.azure.net/.well-known/openid-configuration`.

See [code](Program.cs#L81) for an implementation sample.

### Verify SEVSNP report roots to AMD​

The SEV-SNP attestation report is signed by AMD’s VCEK signing key. The report includes a VCEK certificate chain, which the verifier must validate. The root of this chain must match one of AMD’s published platform root public keys.

### Verify PRSS endorsement for UVM image roots to Key-PRSS-ACI​

TODO

### Verify SEVSNP.launchmeasurement equals COSE.launchmeasurement​

TODO

### Verify SEVSNP.hostdata matches hash of Rego policy containing Key-PRSS-MAA​

TODO

### Verify SEVSNP.reportdata matches hash of MAA runtime claims​

TODO

## How to Run

### Prerequisites

- [.NET SDK 8.0+](https://dotnet.microsoft.com/download)
- Internet access
- Attestation instance URL (e.g., `https://instance.attest.azure.net`)

### Clone and Run

```sh
git clone --recursive https://github.com/Azure-Samples/microsoft-azure-attestation.git
cd microsoft-azure-attestation/cmaa.sevsnp.attest.sample
dotnet restore
dotnet build
dotnet run
```

### Optional: Run in Visual Studio Code

Open the folder in [VS Code](https://code.visualstudio.com/) and press `F5` to start debugging.

## References

- [Microsoft Azure Attestation API](https://github.com/Azure/azure-rest-api-specs/tree/main/specification/attestation/data-plane/Microsoft.Attestation/stable/2022-08-01)
- [Attestation Request Example](https://github.com/Azure/azure-rest-api-specs/blob/main/specification/attestation/data-plane/Microsoft.Attestation/stable/2022-08-01/examples/AttestSevSnpVm.json)
